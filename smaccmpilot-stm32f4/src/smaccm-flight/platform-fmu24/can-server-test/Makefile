UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Linux)
UPLOAD_PORT?=/dev/serial/by-id/usb-3D_Robotics*
endif
CC := arm-none-eabi-gcc
OBJCOPY := arm-none-eabi-objcopy
CFLAGS := -Os
TOWER_STM32_CFLAGS := \
  -g3 -Wall -Werror \
  -std=gnu99 \
  -Wno-parentheses \
  -Wno-unused-function \
  -Wno-unused-variable \
  -mlittle-endian \
  -mthumb -mcpu=cortex-m4 \
  -mfloat-abi=hard -mfpu=fpv4-sp-d16 \
  -DIVORY_TEST \
  -DIVORY_USER_ASSERT_HOOK \
  -I.

LDFLAGS := \
  -mlittle-endian \
  -mthumb -mcpu=cortex-m4 \
  -mfloat-abi=hard -mfpu=fpv4-sp-d16
LDLIBS := -lm

OBJDIR := obj
OBJS := $(addprefix $(OBJDIR)/,freertos_atomic_wrapper.o freertos_semaphore_wrapper.o freertos_mutex_wrapper.o freertos_task_wrapper.o freertos_time_wrapper.o list.o queue.o tasks.o timers.o port.o heap_1.o syscalls.o canDriverTypes.o ivory_serialize.o heartbeat_types.o time_micros_types.o arming_mode_types.o sequence_numbered_packed_status_types.o sequence_num_types.o packed_status_types.o gps_fix_types.o tristate_types.o control_modes_types.o control_source_types.o yaw_mode_types.o throttle_mode_types.o sequence_numbered_control_law_types.o control_law_types.o sequence_numbered_rc_input_types.o rc_input_types.o sequence_numbered_user_input_result_types.o user_input_result_types.o user_input_types.o sequence_numbered_sensors_result_types.o sensors_result_types.o xyz_types.o quaternion_types.o sequence_numbered_gyroscope_sample_types.o gyroscope_sample_types.o sequence_numbered_accelerometer_sample_types.o accelerometer_sample_types.o sequence_numbered_barometer_sample_types.o barometer_sample_types.o sequence_numbered_lidarlite_sample_types.o lidarlite_sample_types.o sequence_numbered_magnetometer_sample_types.o magnetometer_sample_types.o sequence_numbered_px4flow_integral_sample_types.o px4flow_integral_sample_types.o sequence_numbered_px4flow_sample_types.o px4flow_sample_types.o sequence_numbered_position_sample_types.o position_sample_types.o sequence_numbered_control_setpoint_types.o control_setpoint_types.o sequence_numbered_control_output_types.o control_output_types.o sequence_numbered_quadcopter_motors_types.o quadcopter_motors_types.o sequence_numbered_att_control_debug_types.o att_control_debug_types.o pid_state_types.o sequence_numbered_alt_control_debug_types.o alt_control_debug_types.o sequence_numbered_px4io_state_types.o px4io_state_types.o px4io_status_types.o px4io_alarms_types.o sequence_numbered_arming_status_types.o arming_status_types.o sequence_numbered_float_types.o sequence_numbered_pid_config_types.o pid_config_types.o sequence_numbered_throttle_ui_types.o throttle_ui_types.o sequence_numbered_stab_config_types.o stab_config_types.o sequence_numbered_tristate_types.o sequence_numbered_control_modes_types.o sequence_numbered_user_input_types.o sequence_numbered_rgb_led_setting_types.o rgb_led_setting_types.o sequence_numbered_camera_target_types.o camera_target_types.o sequence_numbered_reboot_req_types.o reboot_req_types.o reboot_magic_types.o gps_common.o spiDriverTypes.o mpu6000_response_types.o ms5611_types.o i2cTowerTypes.o attitude_filter.o tower_user_thread_signal_SPI1_IRQHandler.o tower_gen_thread_signal_SPI1_IRQHandler.o tower_user_thread_signal_DMA1_Stream2_IRQHandler.o tower_gen_thread_signal_DMA1_Stream2_IRQHandler.o tower_user_thread_signal_DMA1_Stream4_IRQHandler.o tower_gen_thread_signal_DMA1_Stream4_IRQHandler.o tower_user_thread_signal_I2C1_ER_IRQHandler.o tower_gen_thread_signal_I2C1_ER_IRQHandler.o tower_user_thread_signal_I2C1_EV_IRQHandler.o tower_gen_thread_signal_I2C1_EV_IRQHandler.o tower_user_thread_signal_I2C2_ER_IRQHandler.o tower_gen_thread_signal_I2C2_ER_IRQHandler.o tower_user_thread_signal_I2C2_EV_IRQHandler.o tower_gen_thread_signal_I2C2_EV_IRQHandler.o tower_user_thread_signal_CAN1_RX0_IRQHandler.o tower_gen_thread_signal_CAN1_RX0_IRQHandler.o tower_user_thread_signal_CAN1_RX1_IRQHandler.o tower_gen_thread_signal_CAN1_RX1_IRQHandler.o tower_user_thread_signal_CAN1_TX_IRQHandler.o tower_gen_thread_signal_CAN1_TX_IRQHandler.o tower_user_thread_period_1ms.o tower_gen_thread_period_1ms.o tower_user_thread_period_5ms.o tower_gen_thread_period_5ms.o tower_user_thread_period_10ms.o tower_gen_thread_period_10ms.o tower_user_thread_period_20ms.o tower_gen_thread_period_20ms.o tower_user_thread_period_33ms.o tower_gen_thread_period_33ms.o tower_user_thread_init.o tower_gen_thread_init.o tower_state_monitor_accel_output_attrProxy.o tower_gen_monitor_accel_output_attrProxy.o tower_state_monitor_accel_output_attrServer.o tower_gen_monitor_accel_output_attrServer.o tower_state_monitor_alt_control_debug_attrServer.o tower_gen_monitor_alt_control_debug_attrServer.o tower_state_monitor_altitude_position_pid_attrServer.o tower_gen_monitor_altitude_position_pid_attrServer.o tower_state_monitor_altitude_rate_pid_attrServer.o tower_gen_monitor_altitude_rate_pid_attrServer.o tower_state_monitor_arming_request_attrServer.o tower_gen_monitor_arming_request_attrServer.o tower_state_monitor_arming_status_attrServer.o tower_gen_monitor_arming_status_attrServer.o tower_state_monitor_att_control_debug_attrServer.o tower_gen_monitor_att_control_debug_attrServer.o tower_state_monitor_att_est_sensor_fusion.o tower_gen_monitor_att_est_sensor_fusion.o tower_state_monitor_attitude_pitch_stab_attrServer.o tower_gen_monitor_attitude_pitch_stab_attrServer.o tower_state_monitor_attitude_roll_stab_attrServer.o tower_gen_monitor_attitude_roll_stab_attrServer.o tower_state_monitor_baro_output_attrProxy.o tower_gen_monitor_baro_output_attrProxy.o tower_state_monitor_baro_output_attrServer.o tower_gen_monitor_baro_output_attrServer.o tower_state_monitor_battery_voltage_attrServer.o tower_gen_monitor_battery_voltage_attrServer.o tower_state_monitor_camera_target_input_attrServer.o tower_gen_monitor_camera_target_input_attrServer.o tower_state_monitor_can1PeripheralDriver.o tower_gen_monitor_can1PeripheralDriver.o tower_state_monitor_can_init.o tower_gen_monitor_can_init.o tower_state_monitor_control_law_attrServer.o tower_gen_monitor_control_law_attrServer.o tower_state_monitor_control_modes_request_attrServer.o tower_gen_monitor_control_modes_request_attrServer.o tower_state_monitor_control_output_attrServer.o tower_gen_monitor_control_output_attrServer.o tower_state_monitor_control_setpoint_attrServer.o tower_gen_monitor_control_setpoint_attrServer.o tower_state_monitor_controllableVehicleConsumerOutput.o tower_gen_monitor_controllableVehicleConsumerOutput.o tower_state_monitor_controllableVehicleProducerInput.o tower_gen_monitor_controllableVehicleProducerInput.o tower_state_monitor_detectMotion.o tower_gen_monitor_detectMotion.o tower_state_monitor_fragment_0x100.o tower_gen_monitor_fragment_0x100.o tower_state_monitor_fragment_blindly_0x100.o tower_gen_monitor_fragment_blindly_0x100.o tower_state_monitor_fragment_reassembly.o tower_gen_monitor_fragment_reassembly.o tower_state_monitor_frameBuffer.o tower_gen_monitor_frameBuffer.o tower_state_monitor_gps_output_attrProxy.o tower_gen_monitor_gps_output_attrProxy.o tower_state_monitor_gps_output_attrServer.o tower_gen_monitor_gps_output_attrServer.o tower_state_monitor_gyro_output_attrProxy.o tower_gen_monitor_gyro_output_attrProxy.o tower_state_monitor_gyro_output_attrServer.o tower_gen_monitor_gyro_output_attrServer.o tower_state_monitor_i2c1PeripheralDriver.o tower_gen_monitor_i2c1PeripheralDriver.o tower_state_monitor_i2c1_schedulerasync.o tower_gen_monitor_i2c1_schedulerasync.o tower_state_monitor_i2c2PeripheralDriver.o tower_gen_monitor_i2c2PeripheralDriver.o tower_state_monitor_l3gd20Ctl.o tower_gen_monitor_l3gd20Ctl.o tower_state_monitor_lidarlite_output_attrProxy.o tower_gen_monitor_lidarlite_output_attrProxy.o tower_state_monitor_lidarlite_output_attrServer.o tower_gen_monitor_lidarlite_output_attrServer.o tower_state_monitor_lidarlite_sensor_manager.o tower_gen_monitor_lidarlite_sensor_manager.o tower_state_monitor_lsm303dSensorManager.o tower_gen_monitor_lsm303dSensorManager.o tower_state_monitor_mag_output_attrProxy.o tower_gen_monitor_mag_output_attrProxy.o tower_state_monitor_mag_output_attrServer.o tower_gen_monitor_mag_output_attrServer.o tower_state_monitor_motion_light_debug.o tower_gen_monitor_motion_light_debug.o tower_state_monitor_motor_output_attrServer.o tower_gen_monitor_motor_output_attrServer.o tower_state_monitor_mpu6kCtl.o tower_gen_monitor_mpu6kCtl.o tower_state_monitor_ms5611SPISensorManager.o tower_gen_monitor_ms5611SPISensorManager.o tower_state_monitor_nominal_throttle_attrServer.o tower_gen_monitor_nominal_throttle_attrServer.o tower_state_monitor_packed_status_attrServer.o tower_gen_monitor_packed_status_attrServer.o tower_state_monitor_px4flow_int_output_attrServer.o tower_gen_monitor_px4flow_int_output_attrServer.o tower_state_monitor_px4flow_output_attrProxy.o tower_gen_monitor_px4flow_output_attrProxy.o tower_state_monitor_px4flow_output_attrServer.o tower_gen_monitor_px4flow_output_attrServer.o tower_state_monitor_px4flow_sensor_manager.o tower_gen_monitor_px4flow_sensor_manager.o tower_state_monitor_px4io_state_attrServer.o tower_gen_monitor_px4io_state_attrServer.o tower_state_monitor_rc_input_attrServer.o tower_gen_monitor_rc_input_attrServer.o tower_state_monitor_reboot_req_attrServer.o tower_gen_monitor_reboot_req_attrServer.o tower_state_monitor_rgb_led_attrServer.o tower_gen_monitor_rgb_led_attrServer.o tower_state_monitor_rgbled.o tower_gen_monitor_rgbled.o tower_state_monitor_sensor_enable.o tower_gen_monitor_sensor_enable.o tower_state_monitor_sensor_fusion_proxy.o tower_gen_monitor_sensor_fusion_proxy.o tower_state_monitor_sensors_output_attrServer.o tower_gen_monitor_sensors_output_attrServer.o tower_state_monitor_spi1PeripheralDriver.o tower_gen_monitor_spi1PeripheralDriver.o tower_state_monitor_spi1_scheduler.o tower_gen_monitor_spi1_scheduler.o tower_state_monitor_throttle_ui_attrServer.o tower_gen_monitor_throttle_ui_attrServer.o tower_state_monitor_uart4_dma_rx_byte_shim.o tower_gen_monitor_uart4_dma_rx_byte_shim.o tower_state_monitor_uart_dma.o tower_gen_monitor_uart_dma.o tower_state_monitor_ubloxGPS.o tower_gen_monitor_ubloxGPS.o tower_state_monitor_user_input_attrServer.o tower_gen_monitor_user_input_attrServer.o tower_state_monitor_user_input_request_attrServer.o tower_gen_monitor_user_input_request_attrServer.o tower_state_monitor_yaw_position_pid_attrServer.o tower_gen_monitor_yaw_position_pid_attrServer.o tower_state_monitor_yaw_rate_pid_attrServer.o tower_gen_monitor_yaw_rate_pid_attrServer.o tower_init.o stm32_main.o tower_time.o ref_to_uint32.o stm32_freertos_init.o vector_table.o stm32_freertos_user_assert.o)

default: $(OBJDIR) $(OBJS) image image.px4

image.px4: bl_image.bin
	python px_mkfw.py --prototype=px4fmu-v2.prototype  --image=$< > $@

bl_image.bin: bl_image
	$(OBJCOPY) -O binary $< $@

bl_image: $(OBJS)
	$(CC) -o $@ $(LDFLAGS) -Wl,--script=bl_linker_script.lds -Wl,-Map=$@.map $(OBJS) $(LDLIBS)

upload: image.px4
ifndef UPLOAD_PORT
	@echo "*** User expected to set UPLOAD_PORT environment variable, exiting. ***"
else
	@echo "*** Uploading ***"
	python px_uploader.py --port=$(UPLOAD_PORT) $<
endif



image: $(OBJS)
	$(CC) -o $@ $(LDFLAGS) -Wl,--script=linker_script.lds -Wl,-Map=$@.map $(OBJS) $(LDLIBS)

$(OBJDIR)/%.o : %.c
	$(CC) $(TOWER_STM32_CFLAGS) $(CFLAGS) -c -o $@ $<

$(OBJDIR)/%.o : %.s
	$(CC) $(TOWER_STM32_CFLAGS) $(CFLAGS) -c -o $@ $<

$(OBJDIR):
	mkdir -p $(OBJDIR)

clean:
	-rm -rf obj
	-rm image
	-rm image.map

