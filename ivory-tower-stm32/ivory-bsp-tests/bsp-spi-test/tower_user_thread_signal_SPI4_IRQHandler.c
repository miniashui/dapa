/* This file has been autogenerated by Ivory
 * Compiler version  0.1.0.5
 */
#include "tower_user_thread_signal_SPI4_IRQHandler.h"

void callback_irq_thread_signal_SPI4_IRQHandler(const int64_t *n_var0)
{
    int32_t n_deref0 = reqbufferpos;
    int32_t n_deref1 = reqbuffer.tx_len;
    int32_t n_deref2 = resbufferpos;
    int32_t n_deref3 = resbuffer.rx_idx;
    
    /* reg get spi4->sr:  */
    ;
    
    uint16_t n_r4 = ivory_hw_io_read_u16((uint32_t) 1073820680U);
    
    if ((bool) (0 != (uint8_t) (uint16_t) ((uint16_t) (n_r4 >> 0) & (uint16_t) 1U))) {
        if ((bool) (n_deref2 < n_deref3)) {
            /* reg get spi4->dr:  */
            ;
            
            uint16_t n_r5 = ivory_hw_io_read_u16((uint32_t) 1073820684U);
            
            resbuffer.rx_buf[n_deref2] = (uint8_t) (uint16_t) ((uint16_t) (n_r5 >> 0) & (uint16_t) 255U);
            resbufferpos = (int32_t) ((int32_t) 1 + n_deref2) % 128;
        }
        if ((bool) (n_deref0 < n_deref1)) {
            /* still more to send */
            ;
            
            uint16_t n_r6 = ivory_hw_io_read_u16((uint32_t) 1073820676U);
            
            /* reg modify spi4->cr2: setBit spi_cr2_txeie, clearBit spi_cr2_rxneie */
            ;
            ivory_hw_io_write_u16((uint32_t) 1073820676U, (uint16_t) ((uint16_t) (n_r6 | (uint16_t) ((uint16_t) 1U << (uint16_t) 7U)) & (uint16_t) ~(uint16_t) ((uint16_t) 1U << (uint16_t) 6U)));
        }
        if ((bool) (n_deref2 == (int32_t) (n_deref3 - (int32_t) 1) % 128)) {
            /* done receiving */
            ;
            
            uint16_t n_r7 = ivory_hw_io_read_u16((uint32_t) 1073820676U);
            
            /* reg modify spi4->cr2: setBit spi_cr2_txeie, clearBit spi_cr2_rxneie */
            ;
            ivory_hw_io_write_u16((uint32_t) 1073820676U, (uint16_t) ((uint16_t) ~(uint16_t) ((uint16_t) 1U << (uint16_t) 6U) & (uint16_t) ((uint16_t) ((uint16_t) 1U << (uint16_t) 7U) | n_r7)));
        }
    } else {
        if ((bool) (0 != (uint8_t) (uint16_t) ((uint16_t) (n_r4 >> (uint16_t) 1U) & (uint16_t) 1U))) {
            if ((bool) (n_deref0 < n_deref1)) {
                uint8_t n_deref8 = reqbuffer.tx_buf[n_deref0];
                
                /* reg set spi4->dr: setField spi_dr_data */
                ;
                ivory_hw_io_write_u16((uint32_t) 1073820684U, (uint16_t) ((uint16_t) n_deref8 << 0));
                reqbufferpos = (int32_t) ((int32_t) 1 + n_deref0) % 128;
                if ((bool) (n_deref2 < n_deref3)) {
                    /* still more to receive */
                    ;
                    
                    uint16_t n_r9 = ivory_hw_io_read_u16((uint32_t) 1073820676U);
                    
                    /* reg modify spi4->cr2: clearBit spi_cr2_txeie, setBit spi_cr2_rxneie */
                    ;
                    ivory_hw_io_write_u16((uint32_t) 1073820676U, (uint16_t) ((uint16_t) ((uint16_t) 1U << (uint16_t) 6U) | (uint16_t) (n_r9 & (uint16_t) ~(uint16_t) ((uint16_t) 1U << (uint16_t) 7U))));
                }
            }
            if ((bool) ((bool) (n_deref0 >= n_deref1) && (bool) ((bool) (n_deref2 >= (int32_t) (n_deref3 - (int32_t) 1) % 128) && (bool) (0 == (uint8_t) (uint16_t) ((uint16_t) (n_r4 >> (uint16_t) 7U) & (uint16_t) 1U))))) {
                /* transaction done; disable interrupts and let watchdog */
                ;
                /* shut down the device once the bus isn't busy */
                ;
                
                uint16_t n_r10 = ivory_hw_io_read_u16((uint32_t) 1073820676U);
                
                /* reg modify spi4->cr2: clearBit spi_cr2_txeie */
                ;
                ivory_hw_io_write_u16((uint32_t) 1073820676U, (uint16_t) ((uint16_t) ~(uint16_t) ((uint16_t) 1U << (uint16_t) 7U) & n_r10));
                shutdown = true;
            }
        }
    }
    /* reg set nvic_iser2: setBit nvic_iser_setena.[20] */
    ivory_hw_io_write_u32((uint32_t) 3758153992U, (uint32_t) ((uint32_t) 1U << (uint32_t) 20U));
}
